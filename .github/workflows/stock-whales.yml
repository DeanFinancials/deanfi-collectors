name: Stock Whale Trades Collection

on:
  schedule:
    # 12:30 PM ET (mid-market, 30 min after options whales) - EST: 17:30 UTC, EDT: 16:30 UTC
    - cron: '30 17 * * 1-5'  # EST (Nov-Mar)
    # - cron: '30 16 * * 1-5'  # EDT (Mar-Nov) - uncomment when observing daylight saving time
    
    # 9:30 PM ET (post-market, 30 min after options whales) - EST: 02:30 UTC next day, EDT: 01:30 UTC next day
    - cron: '30 2 * * 2-6'   # EST (Nov-Mar) - runs Tue-Sat for Mon-Fri market close
    # - cron: '30 1 * * 2-6'   # EDT (Mar-Nov) - uncomment when observing daylight saving time
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (5 sample tickers only)'
        required: false
        default: false
        type: boolean

env:
  DATA_REPO: "${{ github.repository_owner }}/deanfi-data"
  DATA_REPO_TOKEN: "${{ secrets.DATA_REPO_TOKEN }}"
  ALPACA_API_KEY: "${{ secrets.ALPACA_API_KEY }}"
  ALPACA_API_SECRET: "${{ secrets.ALPACA_API_SECRET }}"

jobs:
  fetch-stock-whales:
    runs-on: ubuntu-latest
    
    # Queue all data collectors to prevent git conflicts when writing to deanfi-data repo
    concurrency:
      group: deanfi-data-repo
      cancel-in-progress: false
    
    steps:
      - name: Checkout collectors repo
        uses: actions/checkout@v4
      
      - name: Checkout data repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DATA_REPO }}
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: data-cache
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Fetch stock whale trades
        run: |
          cd stockwhales
          
          # Build command with optional flags
          CMD="python fetch_stock_whales.py"
          
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            CMD="$CMD --test"
            echo "ðŸ§ª Running in TEST mode (5 sample tickers)"
          fi
          
          echo "ðŸ‹ Starting stock whale collection..."
          $CMD
          echo "âœ… Stock whale collection complete"
      
      - name: Copy output to data repo
        run: |
          mkdir -p data-cache/stock-whales
          cp stockwhales/*.json data-cache/stock-whales/ 2>/dev/null || echo "No JSON files found in stockwhales/"
          echo "ðŸ“¦ Output files:"
          ls -la data-cache/stock-whales/
      
      - name: Commit and push to data repo
        run: |
          cd data-cache
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stock-whales/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Determine run type for commit message
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              RUN_TYPE="manual"
            else
              HOUR=$(date -u +%H)
              if [ "$HOUR" -ge "15" ] && [ "$HOUR" -le "18" ]; then
                RUN_TYPE="mid-market"
              else
                RUN_TYPE="post-market"
              fi
            fi
            
            git commit -m "ðŸ‹ Stock whale trades update ($RUN_TYPE) - $(date -u +'%Y-%m-%d %H:%M UTC')"
            git pull --rebase origin main
            git push
            echo "âœ… Changes pushed to data repo"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ‹ Stock Whale Collection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "data-cache/stock-whales/stock_whale_summary.json" ]; then
            echo "- **Generated**: $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
            # Extract stats using Python
            TICKERS=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('metadata',{}).get('tickers_scanned','N/A'))")
            WHALES=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('metadata',{}).get('tickers_with_whales','N/A'))")
            TRADES=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('metadata',{}).get('total_whale_trades','N/A'))")
            SENTIMENT=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('overall_sentiment',{}).get('direction','N/A'))")
            BUY_SELL=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('overall_sentiment',{}).get('buy_sell_ratio','N/A'))")
            DP_COUNT=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('dark_pool_sentiment',{}).get('trade_count','N/A'))")
            DP_PCT=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('dark_pool_sentiment',{}).get('pct_of_whale_volume','N/A'))")
            DP_SENTIMENT=$(python3 -c "import json; d=json.load(open('data-cache/stock-whales/stock_whale_summary.json')); print(d.get('dark_pool_sentiment',{}).get('direction','N/A'))")
            echo "- **Tickers Scanned**: $TICKERS" >> $GITHUB_STEP_SUMMARY
            echo "- **Tickers with Whales**: $WHALES" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Whale Trades**: $TRADES" >> $GITHUB_STEP_SUMMARY
            echo "- **Overall Sentiment**: $SENTIMENT" >> $GITHUB_STEP_SUMMARY
            echo "- **Buy/Sell Ratio**: $BUY_SELL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŒ‘ Dark Pool Activity" >> $GITHUB_STEP_SUMMARY
            echo "- **Dark Pool Trades**: $DP_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Dark Pool % of Volume**: $DP_PCT%" >> $GITHUB_STEP_SUMMARY
            echo "- **Dark Pool Sentiment**: $DP_SENTIMENT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Summary file not found" >> $GITHUB_STEP_SUMMARY
          fi
